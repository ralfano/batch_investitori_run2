<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
                                   "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
 <!-- TABELLA ORDINI -->
 <class name="it.ras.arco.bean.FinOrdine" table="FIN_ORDINE" 
		batch-size="1"
 		where="GSTD_ESIST_B='S'" select-before-update="true">
  
  <id name="ordineId" column="ORDINE_ID" type="integer">
   <generator class="sequence">
    <param name="sequence">FIN_ORDINE_SEQ</param>
   </generator>
  </id>
   
  <property name="stato" type="string" column="STATO_T" length="3"/>
  <property name="flgBuySell" type="string" column="FLG_BUY_SELL_B" length="1"/>
  <property name="causale" type="string" column="CAUSALE_T" length="3"/>
  <property name="dataInserimentoOrdine" type="date" column="DATA_INSERIMENTO_D"/>
  <property name="dataEsecuzione" type="date" column="DATA_ESECUZIONE_D"/>
  <property name="numOrdineExt" type="string" column="NUM_ORDINE_EXT_S" length="20"/>
  <property name="divisa" type="string" column="DIVISA_T" length="3"/>
  <property name="importo" type="double" column="IMPORTO_C"/>
  <property name="importoNew" type="double" column="IMPORTO_C" update="false" insert="false"/>
  <property name="quantita" type="double" column="QUANTITA_C"/>
  <property name="quantitaNew" type="double" column="QUANTITA_C" update="false" insert="false"/>
  <property name="quantitaRim" type="double" column="QUANTITA_RIM_C"/>
  <property name="tipoPrezzo" type="string" column="TIPO_PREZZO_T" length="3"/>
  <property name="prezzoLimite" type="double" column="PREZZO_LIMITE_C"/>
  <property name="oraLimite" type="date" column="ORA_LIMITE_D"/>
  <property name="dataLimite" type="date" column="DATA_LIMITE_D"/>
  <property name="limiteStopLoss" type="double" column="LIMITE_STOP_LOSS_C"/>
  <property name="liqPrenot" type="double" column="LIQ_PRENOT_C"/>
  <property name="dataRevoca" type="date" column="DATA_REVOCA_D"/>
  <property name="numRevExt" type="string" column="NUM_REV_EXT_S" length="20"/>
  <property name="tipoRevoca" type="string" column="TIPO_REVOCA_T" length="3"/>
  <property name="tipo" type="string" column="TIPO_T" length="3"/>
  <property name="percentuale" type="double" column="PERCENTUALE_C"/>
  <property name="flagImportoDaDefinire" type="string" column="FLAG_IMPORTO_DA_DEF" length="1"/>
  <property name="flagImportoTot" type="string" column="FLAG_IMPORTO_TOT_B" length="1"/>
  <property name="userUltimaModifica" type="string"
   column="GSTD_ULT_USER_S" length="40"/>
  <property name="proceduraUltimaModifica" type="string"
   column="GSTD_ULT_PROC_S" length="40"/>
  <property name="dataUltimaModifica" type="date" column="GSTD_ULT_MOD_D"/>
  <property name="flagEsistenza" type="string" column="GSTD_ESIST_B" length="1"/>
  <property name="utenteInserimento" type="string"
   column="GSTD_USER_INS_S" length="40"/>
  <property name="tipoUltimaModifica" type="string"
   column="GSTD_TIPO_MOD_B" length="1"/>
  <property name="flagConflInteresse" type="string"
   column="FLAG_CONFL_INTERESSE" length="1"/>
  <property name="flagAdeguatezza" type="string"
   column="FLAG_ADEGUATEZZA" length="1"/>
  <property name="motivoOrdInadeguato" type="string"
   column="MOTIVO_ORD_INADEGUATO" length="100"/> 
  <property name="dataInserimento" type="date" column="GSTD_INSE_D"/>
  <property name="userUltimaModificaSlave" type="string" column="GSTD_ULT_USER_S" length="40" insert="false" update="false" />
  <property name="proceduraUltimaModificaSlave" type="string" column="GSTD_ULT_PROC_S" length="40" insert="false" update="false" />
  <property name="dataUltimaModificaSlave" type="timestamp" column="GSTD_ULT_MOD_D" insert="false" update="false" />
  <property name="tipoUltimaModificaSlave" type="string" column="GSTD_TIPO_MOD_B" length="1" insert="false" update="false" />
  <property name="codiceSconto" type="string" column="CODICE_SCONTO" length="8"/>
  <property name="codiceConvenzione" type="string" column="COD_CONVENZIONE" length="8"/>
  <property name="flgNoPagAmministrative" type="string" column="FLG_NO_PAG_AMMINISTRATIVE" length="1"/>
  <property name="conferimentoMisto" type="string" column="CONFERIMENTO_MISTO" length="1"/>
  <property name="note" type="string" column="NOTE" length="200"/>
  <property name="flagInAttesaDiLiberatoria" type="string" column="FLAG_ATTESA_LIBERATORIA" length="1"/>
  <property name="dataRicezioneLiberatoria" type="date" column="DATA_RICEZIONE_LIBERATORIA"/>
  <property name="ordine" type="integer" column="ORDINE_N"/>
  <property name="flagNuovoContrattoB" type="string" column="FLAG_NUOVO_CONTRATTO_B" length="1"/>

  <!-- RELAZIONE CON FIN_MOVIMENTO-->
  <set name="movimenti" lazy="true" inverse="true"  cascade="none,lock" where ="GSTD_ESIST_B='S'" >
   <key column="ORDINE_ID"/>
   <one-to-many class="it.ras.arco.bean.FinMovimento" not-found="ignore" />
  </set>
  
  <!-- RELAZIONE CON FIN_SOTTOSCRIZIONE-->
  <many-to-one name="sottoscrizione"
   class="it.ras.arco.bean.FinSottoscrizione" column="SOTTOSCRIZIONE_ID" 
   lazy="proxy" outer-join="true" 
   fetch="select"
   not-null="false" not-found="ignore" cascade="lock,none" />


  <!-- RELAZIONE CON FIN_CONTRATTO-->
<!--
  <many-to-one name="contratto"
   class="it.ras.arco.bean.FinContratto" column="CONTRATTO_ID" not-found="ignore" cascade="lock" />
-->

  <!-- RELAZIONE CON FIN_POSIZIONE -->
   <many-to-one name="posizione"
	 class="it.ras.arco.bean.FinPosizione" column="POSIZIONE_ID" not-found="ignore" 
	 fetch="select"
	 cascade="save-update, lock" insert="true" update="true"
	 />
	 
<!--	ERRATA
 <set name="posizioni"  where ="GSTD_ESIST_B='S'" cascade="lock,save-update" 
     lazy="true"  inverse="true" >
   <key column="ORDINE_ID"/>
   <one-to-many class="it.ras.arco.bean.FinPosizione"  not-found="ignore" />
  </set>
-->


  <!--  FRANCESCO: la relazione correta e' quella many-to-one -->
  <!-- RELAZIONE CON FIN_ATT_FIN -->   
  <many-to-one name="attivitaFin" lazy="proxy"
  	 class="it.ras.arco.bean.FinAttivitaFinanziaria" 
  	 column="ATTIVITA_FIN_ID" unique="true"
  	 insert="true" update="true"
  	 fetch="select"
  	 cascade="lock" not-found="ignore" 
  	 /> 


  <many-to-one name="certificato" lazy="proxy"
  	 class="it.ras.arco.bean.FinCertificato" 
  	 column="CERTIFICATO_ID" 
  	 fetch="select"
  	 cascade="save-update,lock" not-found="ignore" 
  	 /> 



  <!--
	ORDINE COLLEGATO:
	Nel caso di trasferimenti tra SICAV l'ordine di disinvestimento
	ha come 'ordineCollegato' quello di investimento.
  -->
  <many-to-one name="ordineCollegato" lazy="false"
  	 class="it.ras.arco.bean.FinOrdine" 
  	 column="ORDINE_COLL_ID" 
  	 fetch="select"
  	 cascade="save-update,lock" not-found="ignore" 
  	 /> 


   
 </class>

 <!--query name="Outbound">from it.ras.arco.bean.FinOrdine o where o.ordineId = 1</query-->

 <query name="Verifica_Ordine">from it.ras.arco.bean.FinOrdine o where o.ordineId = ?</query>
 
  <query name="GetOrdiniBySottoscrizioneId">from it.ras.arco.bean.FinOrdine o where o.sottoscrizione = :sottoscrizioneId</query>
  
 <sql-query name="GetOrdineByOrdineIDMD">
<return alias="ordine" class="it.ras.arco.bean.FinOrdine"/>
select {ordine.*} from FIN_ORDINE    ordine
where
 ordine.ORDINE_ID = :ordineId
</sql-query>
 
 <!--<query name="CheckGetOrdineByOrdineIDMD">from it.ras.arco.bean.FinOrdine o where o.ordineId = ?</query>
-->
<query name="FIN_ORDINE_CheckGetOrdineByOrdineIDMD">from it.ras.arco.bean.FinOrdine o where o.ordineId = ?</query>

<query name="getOperazioniOdiernePerRimborsi">
from it.ras.arco.bean.FinOrdine o
	where o.dataInserimentoOrdine &lt; sysdate
	and o.dataInserimentoOrdine &gt; sysdate-1
	and o.tipo in ('500', '830', '840')
	and o.posizione = :posizione
</query>

<query name="getOperazioniSottoscrizioniOdiernePerRimborsi">
	<![CDATA[
	from it.ras.arco.bean.FinOrdine o
	where o.stato not in('E', 'K')
	and o.tipo in ('102','100','330','331','130','830','130','140','150','830','840','850','500','530')
	and o.posizione = :posizione
    ]]>
</query> 

<query name="getOperazioniSottoscrizioniOdiernePerRimborsiDiFondi">
	<![CDATA[
	from it.ras.arco.bean.FinOrdine o
	where o.stato not in('E', 'K')
	and o.tipo in ('102','100')
	and o.posizione = :posizione
    ]]>
</query> 

<query name="getOperazioniSottoscrizioniOdiernePerRimborsiDiFondiConRam">
	<![CDATA[
	from it.ras.arco.bean.FinOrdine o
	where o.stato not in('E', 'K')
	and o.posizione = :posizione
	and o.ordineId <> :ordineId
	and ( (o.tipo in ('102','100')) or 
	(o.tipo in ('500','530') and  '14'=:emittenteId ))
    ]]>
</query>



<!--
		where o.ordineId <> :ordineId
-->
<query name="CARICA_ALTRI_ORDINI_DI_POSIZIONE">
	<![CDATA[
		select  o
		from 	it.ras.arco.bean.FinOrdine o
				join o.posizione pos
		where 	pos.posizioneId = :posizioneId
		and 	o.stato in ('A', 'I')
		and 	o.tipo  in ('100', '102', '130', '140', '150', '330', '331', '500', '530', '830', '840', '850')
	]]>
</query>


<query name="CARICA_RIMBORSI_PARZIALI_DI_POSIZIONE">
	<![CDATA[
		select  sum (o.importo)
		from 	it.ras.arco.bean.FinOrdine o
				join o.posizione pos
		where 	pos.posizioneId = :posizioneId
		and 	o.ordineId <> :ordineId
		and 	o.stato not in ('E', 'K', 'F')
		and 	o.tipo  in ('530')
	]]>
</query>


<!-- 
		and	    o.posizione.contratto.numContratto = :numContratto
		and 	o.posizione.posizioneId = :posizioneId
-->
<query name="INDIVIDUA_IDENTICA_SOTTOSCRIZIONE_TRASFERIMENTO">
	<![CDATA[
		select  o.sottoscrizione
		from 	it.ras.arco.bean.FinOrdine o
				join o.posizione pos
				join pos.contratto c
		where 	o.stato in ('A', 'I')
		and 	o.tipo  = '130'
		and	    c.numContratto = :numContratto
		and 	pos.posizioneId = :posizioneId
	]]>
</query>


<!-- 
 	where s.posizione.servizioAgg.servAggiunId = :servizio 
--> 
 <query name="GetCountOrdineByServAgg">
 	select count(s) 
 	from  it.ras.arco.bean.FinOrdine s 
 			join s.posizione p
 			join p.servizioAgg sa
 	where sa.servAggiunId = :servizio 
 	and s.causale='330'
 	and s.stato='A'
 </query>
 
 <query name="getPrimaSottoscrizioneIdByContrattoId">
	<![CDATA[
		select  s.sottoscrizioneId
		from 	it.ras.arco.bean.FinOrdine o
				join o.sottoscrizione s
				join o.posizione pos
				join pos.contratto c
		where 	o.tipo  = '100'
		and	    c.contrattoId = :contrattoId
	]]>
</query>

</hibernate-mapping>

